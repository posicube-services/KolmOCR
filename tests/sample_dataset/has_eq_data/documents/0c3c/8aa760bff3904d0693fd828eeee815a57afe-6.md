---
primary_language: en
is_rotation_valid: True
rotation_correction: 0
is_table: False
is_diagram: False
---
Algorithm 1 Algorithm to get the normal for a line by intersection with base surfels.
SurfelLineIntersect(Line l, Surfel s1, Surfel s2, Normal n)
d := ||P1 âˆ’ P2||;
if (d < rs1 + rs2) // bounding spheres of s1 and s2 intersect
  if (s2 âˆˆ Nbase)
    P := IntersectionPoint(l, s2);
    d := ||P âˆ’ P2||;
    if (d < rs2)
      // l intersects s2
      n := n + ð’²s2(d) Â· ns2;
    end if
  else
    for each child surfel c of s2 do
      SurfelLineIntersect(l, s1, c, n);
    end for
  end if
end if
NormalForLine(Line l, Surfel s, Normal n)
n := (0, 0, 0)T;
SurfelLineIntersect(l, s, rootSurfel, n);
n := n/||n||;
end

Algorithm 2 Algorithm to get the normal for a line by intersection with a triangle that is a surfel child node.
PrimitiveIntersect(Line l, Surfel s, Primitive p, Normal n)
B := BoundingSphere(p);
d := ||P1 âˆ’ MB||;
if (d < rs + rB) // bounding spheres of s and p intersect
  if (p is triangle)
    if (l intersects p)
      P := IntersectionPoint(l, p);
      C := BarycentricCoordinates(P, p);
      n := uCnA + vCnB + wCnC;
    end if
  else
    for each child surfel c of p do
      PrimitiveIntersect(l, s, c, n);
    end for
  end if
end if
NormalForLine(Line l, Surfel s, Normal n)
  PrimitiveIntersect(l, s, rootSurfel, n);
end

sured (see d4 and d7 in fig. 7(a)). Then the weights wsj are given by:

wsj = ð’²sj(dsj).  (14)

The final procedure to get the normal nK,x,y of a raster point PK,x,y that forms together with the surfel normal n a line is summarized in algorithm 1. Finally the normal nK,x,y is coded to RGB values and stored in the normal map.

4.2 Normal Map for Hybrid Hierarchies
If the highest available LOD in the hierarchy is a triangular mesh, then an algorithm similar to that for pure point hierarchies will be used. Since triangles do not overlap in well-formed triangular meshes only the triangle that intersects the line l through raster point PK,x,y have to be found, instead of a set of base surfels. If this triangle l = (A, B, C) was found, the normal at the intersection point is interpolated using barycentric coordinates c = (u, v, w)T at this point:

nK,x,y = u nA + v nB + w nC   (15)

The pseudo-code for this procedure is shown in algorithm 2.

4.3 Normal Map Size
To create a normal map for a point hierarchies a raster size (ws, hs) has to be selected for every surfel s in addition to the algorithms described before. Since surfel disks are circular it is natural to choose hs = ws. For base surfels of a pure point hierarchy we only need one pixel (ws = 1), to store the surfel normal itself. For every inner surfel of the point hierarchy the same ws can be choosen, because surfel size in image space is limited by a quality threshold (see section 5). As it can be seen in fig. 8 this ws should exceed at least the half of this threshold to preserve features.

![Comparisons of images of a meteoroid model allowing surfels up to a radius of 16 pixel in the interior and using different normal map sizes.](page_1024_1206_388_388.png)

Figure 8: Comparisons of images of a meteoroid model allowing surfels up to a radius of 16 pixel in the interior and using different normal map sizes.

2x2    4x4
8x8    16x16